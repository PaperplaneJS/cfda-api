!function(t){var e={};function n(d){if(e[d])return e[d].exports;var s=e[d]={i:d,l:!1,exports:{}};return t[d].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,d){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:d})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var d=Object.create(null);if(n.r(d),Object.defineProperty(d,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(d,s,function(e){return t[e]}.bind(null,s));return d},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=2)}([function(t,e){t.exports=function(t,e){let n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),d=[],s=0;for(e=e||16,t=t||8,s=0;s<t;s++)d[s]=n[0|Math.random()*e];return d.join("")}},function(t,e,n){const d=n(11);t.exports=function(t){return d.createHash("sha256").update(t).digest("hex")}},function(t,e,n){n(3),n(4);const d=n(5),s=n(6).MongoClient,i=n(7),o=n(8),a=d.createServer({name:"cfda_ser"}),r=o({origins:["http://127.0.0.1:8080","http://localhost:8080"],credentials:!0});a.pre(r.preflight),a.use(r.actual),a.use(d.plugins.queryParser()),a.use(d.plugins.bodyParser());const p=new s("mongodb://localhost:27017",{useNewUrlParser:!0});p.connect().then(()=>{const t=p.db("cfda");t.collection("config").findOne({}).then(e=>{a.use(i({cookieName:"cfdaId",secret:e.key,duration:12e5,activeDuration:12e5,cookie:{httpOnly:!1}})),a.use(function(t,e,n){if(["/login","/auth"].includes(t.path())||t.cfdaId.staff)return n();e.status(401),e.send()});const d=n(9);d.keys().forEach(e=>{let n=d(e);console.log("api on:"+e),n(a,t)}),a.listen("9000","localhost",function(){console.log("%s begin.",a.name)})})})},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("restify")},function(t,e){t.exports=require("mongodb")},function(t,e){t.exports=require("client-sessions")},function(t,e){t.exports=require("restify-cors-middleware")},function(t,e,n){var d={"./action.js":10,"./biz.js":12,"./dep.js":13,"./law.js":14,"./plan.js":15,"./staff.js":16,"./task.js":17,"./template.js":18};function s(t){var e=i(t);return n(e)}function i(t){if(!n.o(d,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return d[t]}s.keys=function(){return Object.keys(d)},s.resolve=i,t.exports=s,s.id=9},function(t,e,n){n(0);const d=n(1);t.exports=function(t,e){const n=e.collection("staff");t.post("/login",(t,e,s)=>{const i=t.body.staff||"",o=t.body.pwd||"",a=d(o);return n.findOne({name:i,pwd:a},{projection:{pwd:0}}).then(d=>{if(d){const s=d;t.cfdaId.staff=s._id,e.send(s),n.findOneAndUpdate({_id:s._id},{$set:{lastLogin:(new Date).toLocaleString()}})}else e.status(401),e.send()}),s()}),t.post("/auth",(t,e,d)=>{const s=t.cfdaId.staff;return s?(n.findOne({_id:s},{projection:{pwd:0}}).then(t=>{t?(e.send(t),n.findOneAndUpdate({_id:t._id},{$set:{lastLogin:(new Date).toLocaleString()}})):(e.status(401),e.send())}),d()):(e.status(401),e.send(),d())})}},function(t,e){t.exports=require("crypto")},function(t,e,n){const d=n(0);t.exports=function(t,e){const n=e.collection("biz");t.get("/biz",(t,e,d)=>(n.find({}).toArray().then(t=>{e.send(t)}),d())),t.get("/biz/:bizid",(t,e,d)=>(n.findOne({_id:t.params.bizid}).then(t=>{t?e.send(t):(e.status(404),e.send())}),d())),t.post("/biz",(t,e,s)=>{const i=t.body;return i._id=d(),n.insertOne(i).then(()=>{e.status(201),e.send(i)}),s()}),t.put("/biz/:bizid",(t,e,d)=>{const s=t.body;return n.findOneAndUpdate({_id:t.params.bizid||""},{$set:s}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?s:void 0)}),d()}),t.del("/biz/:bizid",(t,e,d)=>(n.deleteOne({_id:t.params.bizid||""}).then(()=>{e.status(204),e.send()}),d()))}},function(t,e,n){const d=n(0);function s(t){const e=Math.min(...t.map(t=>t._rel.length)),n=t.filter(t=>t._rel.length<=e);return t.forEach(e=>(function e(n){const d=t.filter(t=>t._rel.length===n._rel.length+1&&t._rel.includes(n._id));d.length>0&&(n.children=d,n.children.forEach(t=>e(t)))})(e)),n}t.exports=function(t,e){const n=e.collection("department");t.get("/dep",(t,e,d)=>(n.find({}).toArray().then(n=>{const d=t.query.cascade;e.send(d?s(n):n)}),d())),t.get("/dep/:depid",(t,e,d)=>{const i=t.query.cascade,o=t.query.under,a=o?"_rel":"_id";let r=n[o?"find":"findOne"]({[a]:t.params.depid});return o&&(r=r.toArray()),r.then(t=>{e.send(i&&o?s(t):t)}),d()}),t.post("/dep",(t,e,s)=>{const i=t.body;return i._id=d(),i._rel.push(i._id),n.insertOne(i).then(()=>{e.status(201),e.send(i)}),s()}),t.put("/dep/:depid",(t,e,d)=>{const s=t.body;return n.findOneAndUpdate({_id:t.params.depid||""},{$set:s}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?s:void 0)}),d()}),t.del("/dep/:depid",(t,e,d)=>(n.deleteOne({_id:t.params.depid||""}).then(()=>{e.status(204),e.send()}),d()))}},function(t,e){t.exports=function(t,e){const n=e.collection("law");t.get("/law",(t,e,d)=>(n.find({},{projection:{content:0}}).toArray().then(t=>{e.send(t)}),d())),t.get("/law/:lawid",(t,e,d)=>(n.findOne({_id:t.params.lawid||""}).then(t=>{t?e.send(t):(e.status(404),e.send())}),d())),t.post("/law",(t,e,d)=>{const s=t.body;return s._id=uuid(),n.insertOne(s).then(()=>{e.status(201),e.send(s)}),d()}),t.put("/law/:lawid",(t,e,d)=>{const s=t.body;return n.findOneAndUpdate({_id:s.params.lawid||""},{$set:s}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?s:void 0)}),d()}),t.del("/law/:lawid",(t,e,d)=>(n.deleteOne({_id:t.params.lawid||""}).then(()=>{e.status(204),e.send()}),d()))}},function(t,e){t.exports=function(t,e){const n=e.collection("plan");t.get("/plan",(t,e,d)=>{let s={};return t.query.kind&&(s.kind=t.query.kind),n.find(s).toArray().then(t=>{e.send(t)}),d()}),t.get("/plan/:planid",(t,e,d)=>{let s={};return s._id=t.params.planid||"",t.query.kind&&(s.kind=t.query.kind),n.findOne(s).then(t=>{t?e.send(t):(e.status(404),e.send())}),d()}),t.post("/plan",(t,e,d)=>{const s=t.body;return s._id=uuid(),n.insertOne(s).then(()=>{e.status(201),e.send(s)}),d()}),t.put("/plan/:planid",(t,e,d)=>{const s=t.body;return n.findOneAndUpdate({_id:t.params.planid||""},{$set:s}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?s:void 0)}),d()}),t.del("/plan/:planid",(t,e,d)=>(n.deleteOne({_id:t.params.planid||""}).then(()=>{e.status(204),e.send()}),d()))}},function(t,e,n){const d=n(0),s=n(1);t.exports=function(t,e){const n=e.collection("staff"),i=e.collection("department");t.get("/staff",(t,e,d)=>{let s={};return t.query.dep&&(s.dep=t.query.dep),t.query.dep&&t.query.under?i.find({_rel:t.query.dep}).toArray().then(t=>t.map(t=>t._id)).then(t=>{n.find({dep:{$in:t}},{projection:{pwd:0}}).toArray().then(t=>{e.send(t)})}):n.find(s,{projection:{pwd:0}}).toArray().then(t=>{e.send(t)}),d()}),t.get("/staff/:staffid",(t,e,d)=>(n.findOne({_id:t.params.staffid},{projection:{pwd:0}}).then(t=>{t?e.send(t):(e.status(404),e.send())}),d())),t.post("/staff",(t,e,i)=>{const o=t.body;return o._id=d(),o.pwd=s(o.pwd),n.insertOne(o).then(()=>{e.status(201),e.send(o)}),i()}),t.put("/staff/:staffid",(t,e,d)=>{const i=t.body;return i.pwd&&(i.pwd=s(i.pwd)),n.findOneAndUpdate({_id:t.params.staffid||""},{$set:i}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?biz:void 0)}),d()}),t.del("/staff/:staffid",(t,e,d)=>(n.deleteOne({_id:t.params.staffid||""}).then(()=>{e.status(204),e.send()}),d()))}},function(t,e){t.exports=function(t,e){const n=e.collection("task");t.get("/plan/:planid/task",(t,e,d)=>(n.find({_plan:t.params.planid||""}).toArray().then(t=>{e.send(t)}),d())),t.get("/plan/:planid/task/:taskid",(t,e,d)=>(n.findOne({_id:t.params.taskid,_plan:t.params.planid}).then(t=>{t?e.send(t):(e.status(404),e.send())}),d())),t.post("/plan/:planid/task",(t,e,d)=>{const s=t.params.planid,i=t.body;return i._id=uuid(),i._plan=s,n.insertOne(i).then(()=>{e.status(201),e.send(i)}),d()}),t.put("/plan/:planid/task/:taskid",(t,e,d)=>{const s=t.body;return n.findOneAndUpdate({_id:t.params.taskid||"",_plan:t.params.taskid||""},{$set:s}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?s:void 0)}),d()}),t.del("/plan/:planid/task/:taskid",(t,e,d)=>(n.deleteOne({_id:t.params.taskid||"",_plan:t.params.taskid||""}).then(()=>{e.status(204),e.send()}),d()))}},function(t,e){t.exports=function(t,e){const n=e.collection("template");t.get("/template",(t,e,d)=>(n.find({},{projection:{pwd:0}}).toArray().then(t=>{e.send(t)}),d())),t.get("/template/:templateid",(t,e,d)=>(n.findOne({_id:t.params.templateid}).then(t=>{e.send(t)}),d())),t.post("/template",(t,e,d)=>{const s=t.body;return s._id=uuid(),n.insertOne(s).then(()=>{e.status(201),e.send(s)}),d()}),t.put("/template/:templateid",(t,e,d)=>{const s=t.body;return n.findOneAndUpdate({_id:t.params.templateid||""},{$set:s}).then(t=>{e.status(t.ok?201:404),e.send(t.ok?s:void 0)}),d()}),t.del("/template/:templateid",(t,e,d)=>(n.deleteOne({_id:t.params.templateid||""}).then(()=>{e.status(204),e.send()}),d()))}}]);
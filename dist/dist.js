!function(n){var t={};function e(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return n[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}e.m=n,e.c=t,e.d=function(n,t,r){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:r})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var i in n)e.d(r,i,function(t){return n[t]}.bind(null,i));return r},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},e.p="",e(e.s=2)}([function(n,t){n.exports=function(n,t){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),r=[],i=0;for(t=t||16,n=n||8,i=0;i<n;i++)r[i]=e[0|Math.random()*t];return r.join("")}},function(n,t,e){var r=e(9);n.exports=function(n){return r.createHash("sha256").update(n).digest("hex")}},function(n,t,e){var r=e(3),i=e(4).MongoClient,a=e(5),o=e(6),d=r.createServer({name:"cfda_ser"}),u=o({origins:[/.*/],credentials:!0});d.pre(u.preflight),d.use(u.actual),d.use(r.plugins.queryParser()),d.use(r.plugins.bodyParser());var s=new i("mongodb://localhost:27017",{useNewUrlParser:!0});s.connect().then(function(){var n=s.db("cfda");n.collection("config").findOne({}).then(function(t){d.use(a({cookieName:"cfdaId",secret:t.key,duration:12e5,activeDuration:12e5,cookie:{httpOnly:!1}})),d.use(function(n,t,e){if(["/login","/auth"].includes(n.path())||n.cfdaId.staff)return e();t.status(401),t.send()});var r=e(7);r.keys().forEach(function(t){var e=r(t);console.log("api on:"+t),e(d,n)}),d.listen("9000","localhost",function(){console.log("%s begin.",d.name)})})})},function(n,t){n.exports=require("restify")},function(n,t){n.exports=require("mongodb")},function(n,t){n.exports=require("client-sessions")},function(n,t){n.exports=require("restify-cors-middleware")},function(n,t,e){var r={"./action.js":8,"./biz.js":10,"./dep.js":11,"./law.js":13,"./plan.js":14,"./staff.js":15,"./task.js":16,"./template.js":17};function i(n){var t=a(n);return e(t)}function a(n){if(!e.o(r,n)){var t=new Error("Cannot find module '"+n+"'");throw t.code="MODULE_NOT_FOUND",t}return r[n]}i.keys=function(){return Object.keys(r)},i.resolve=a,n.exports=i,i.id=7},function(n,t,e){"use strict";e.r(t);var r=e(1),i=e.n(r);t.default=function(n,t){var e=t.collection("staff");n.post("/login",function(n,t,r){var a=n.body.staff||"",o=n.body.pwd||"",d=i()(o);return e.findOne({name:a,pwd:d},{projection:{pwd:0}}).then(function(r){if(r){var i=r;n.cfdaId.staff=i._id,t.res.send(i),e.findOneAndUpdate({_id:i._id},{$set:{lastLogin:(new Date).toLocaleString()}})}else t.status(401),t.send()}),r()}),n.post("/auth",function(n,t,r){var i=n.cfdaId.staff;return i?(e.findOne({_id:i},{projection:{pwd:0}}).then(function(n){n?(t.send(n),e.findOneAndUpdate({_id:n._id},{$set:{lastLogin:(new Date).toLocaleString()}})):(t.status(401),t.send())}),r()):(t.status(401),t.send(),r())})}},function(n,t){n.exports=require("crypto")},function(n,t,e){"use strict";e.r(t);var r=e(0),i=e.n(r);t.default=function(n,t){var e=t.collection("biz");n.get("/biz",function(n,t,r){return e.find({}).toArray().then(function(n){t.send(n)}),r()}),n.get("/biz/:bizid",function(n,t,r){return e.findOne({_id:n.params.bizid}).then(function(n){n?t.send(n):(t.status(404),t.send())}),r()}),n.post("/biz",function(n,t,r){var a=n.body;return a._id=i()(),e.insertOne(a).then(function(){t.status(201),t.send(a)}),r()}),n.put("/biz/:bizid",function(n,t,r){var i=n.body;return e.findOneAndUpdate({_id:n.params.bizid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?i:void 0)}),r()}),n.del("/biz/:bizid",function(n,t,r){return e.deleteOne({_id:n.params.bizid||""}).then(function(){t.status(204),t.send()}),r()})}},function(n,t,e){"use strict";e.r(t),function(n){var t=e(0),r=e.n(t);function i(n){return function(n){if(Array.isArray(n)){for(var t=0,e=new Array(n.length);t<n.length;t++)e[t]=n[t];return e}}(n)||function(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(n){var t=Math.min.apply(Math,i(n.map(function(n){return n._rel.length}))),e=n.filter(function(n){return n._rel.length<=t});return n.forEach(function(t){return function t(e){var r=n.filter(function(n){return n._rel.length===e._rel.length+1&&n._rel.includes(e._id)});r.length>0&&(e.children=r,e.children.forEach(function(n){return t(n)}))}(t)}),e}n.exports=function(n,t){var e=t.collection("department");n.get("/dep",function(n,t,r){return e.find({}).toArray().then(function(e){var r=n.query.cascade;t.send(r?a(e):e)}),r()}),n.get("/dep/:depid",function(n,t,r){var i,o,d,u=n.query.cascade,s=n.query.under,f=s?"_rel":"_id",c=e[s?"find":"findOne"]((i={},o=f,d=n.params.depid,o in i?Object.defineProperty(i,o,{value:d,enumerable:!0,configurable:!0,writable:!0}):i[o]=d,i));return s&&(c=c.toArray()),c.then(function(n){t.send(u&&s?a(n):n)}),r()}),n.post("/dep",function(n,t,i){var a=n.body;return a._id=r()(),a._rel.push(a._id),e.insertOne(a).then(function(){t.status(201),t.send(a)}),i()}),n.put("/dep/:depid",function(n,t,r){var i=n.body;return e.findOneAndUpdate({_id:n.params.depid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?i:void 0)}),r()}),n.del("/dep/:depid",function(n,t,r){return e.deleteOne({_id:n.params.depid||""}).then(function(){t.status(204),t.send()}),r()})}}.call(this,e(12)(n))},function(n,t){n.exports=function(n){if(!n.webpackPolyfill){var t=Object.create(n);t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1}return t}},function(n,t,e){"use strict";e.r(t);var r=e(0),i=e.n(r);t.default=function(n,t){var e=t.collection("law");n.get("/law",function(n,t,r){return e.find({},{projection:{content:0}}).toArray().then(function(n){t.send(n)}),r()}),n.get("/law/:lawid",function(n,t,r){return e.findOne({_id:n.params.lawid||""}).then(function(n){n?t.send(n):(t.status(404),t.send())}),r()}),n.post("/law",function(n,t,r){var a=n.body;return a._id=i()(),e.insertOne(a).then(function(){t.status(201),t.send(a)}),r()}),n.put("/law/:lawid",function(n,t,r){var i=n.body;return e.findOneAndUpdate({_id:n.params.lawid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?i:void 0)}),r()}),n.del("/law/:lawid",function(n,t,r){return e.deleteOne({_id:n.params.lawid||""}).then(function(){t.status(204),t.send()}),r()})}},function(n,t,e){"use strict";e.r(t);var r=e(0),i=e.n(r);t.default=function(n,t){var e=t.collection("plan");n.get("/plan",function(n,t,r){var i={};return n.query.kind&&(i.kind=n.query.kind),e.find(i).toArray().then(function(n){t.send(n)}),r()}),n.get("/plan/:planid",function(n,t,r){var i={};return i._id=n.params.planid||"",n.query.kind&&(i.kind=n.query.kind),e.findOne(i).then(function(n){n?t.send(n):(t.status(404),t.send())}),r()}),n.post("/plan",function(n,t,r){var a=n.body;return a._id=i()(),e.insertOne(a).then(function(){t.status(201),t.send(a)}),r()}),n.put("/plan/:planid",function(n,t,r){var i=n.body;return e.findOneAndUpdate({_id:n.params.planid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?i:void 0)}),r()}),n.del("/plan/:planid",function(n,t,r){return e.deleteOne({_id:n.params.planid||""}).then(function(){t.status(204),t.send()}),r()})}},function(n,t,e){"use strict";e.r(t);var r=e(0),i=e.n(r),a=e(1),o=e.n(a);t.default=function(n,t){var e=t.collection("staff"),r=t.collection("department");n.get("/staff",function(n,t,i){var a={};return n.query.dep&&(a.dep=n.query.dep),n.query.dep&&n.query.under?r.find({_rel:n.query.dep}).toArray().then(function(n){return n.map(function(n){return n._id})}).then(function(n){e.find({dep:{$in:n}},{projection:{pwd:0}}).toArray().then(function(n){t.send(n)})}):e.find(a,{projection:{pwd:0}}).toArray().then(function(n){t.send(n)}),i()}),n.get("/staff/:staffid",function(n,t,r){return e.findOne({_id:n.params.staffid},{projection:{pwd:0}}).then(function(n){n?t.send(n):(t.status(404),t.send())}),r()}),n.post("/staff",function(n,t,r){var a=n.body;return a._id=i()(),a.pwd=o()(a.pwd),e.insertOne(a).then(function(){t.status(201),t.send(a)}),r()}),n.put("/staff/:staffid",function(n,t,r){var i=n.body;return i.pwd&&(i.pwd=o()(i.pwd)),e.findOneAndUpdate({_id:n.params.staffid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?biz:void 0)}),r()}),n.del("/staff/:staffid",function(n,t,r){return e.deleteOne({_id:n.params.staffid||""}).then(function(){t.status(204),t.send()}),r()})}},function(n,t,e){"use strict";e.r(t);var r=e(0),i=e.n(r);t.default=function(n,t){var e=t.collection("task");n.get("/plan/:planid/task",function(n,t,r){return e.find({_plan:n.params.planid||""}).toArray().then(function(n){t.send(n)}),r()}),n.get("/plan/:planid/task/:taskid",function(n,t,r){return e.findOne({_id:n.params.taskid,_plan:n.params.planid}).then(function(n){n?t.send(n):(t.status(404),t.send())}),r()}),n.post("/plan/:planid/task",function(n,t,r){var a=n.params.planid,o=n.body;return o._id=i()(),o._plan=a,e.insertOne(o).then(function(){t.status(201),t.send(o)}),r()}),n.put("/plan/:planid/task/:taskid",function(n,t,r){var i=n.body;return e.findOneAndUpdate({_id:n.params.taskid||"",_plan:n.params.taskid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?i:void 0)}),r()}),n.del("/plan/:planid/task/:taskid",function(n,t,r){return e.deleteOne({_id:n.params.taskid||"",_plan:n.params.taskid||""}).then(function(){t.status(204),t.send()}),r()})}},function(n,t,e){"use strict";e.r(t);var r=e(0),i=e.n(r);t.default=function(n,t){var e=t.collection("template");n.get("/template",function(n,t,r){return e.find({},{projection:{pwd:0}}).toArray().then(function(n){t.send(n)}),r()}),n.get("/template/:templateid",function(n,t,r){return e.findOne({_id:n.params.templateid}).then(function(n){t.send(n)}),r()}),n.post("/template",function(n,t,r){var a=n.body;return a._id=i()(),e.insertOne(a).then(function(){t.status(201),t.send(a)}),r()}),n.put("/template/:templateid",function(n,t,r){var i=n.body;return e.findOneAndUpdate({_id:n.params.templateid||""},{$set:i}).then(function(n){t.status(n.ok?201:404),t.send(n.ok?i:void 0)}),r()}),n.del("/template/:templateid",function(n,t,r){return e.deleteOne({_id:n.params.templateid||""}).then(function(){t.status(204),t.send()}),r()})}}]);